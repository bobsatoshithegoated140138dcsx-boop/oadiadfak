local Players = gameGetService(Players)
local RunService = gameGetService(RunService)
local UserInputService = gameGetService(UserInputService)

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAddedWait()
local HRP = CharacterWaitForChild(HumanoidRootPart)

local following = false
local targetPlayer = nil
local followDistanceX = 0
local followDistanceY = 0
local followDistanceZ = 0
local minimized = false
local minDistance = -500
local maxDistance = 500

-- GUI生成
local ScreenGui = Instance.new(ScreenGui)
ScreenGui.Name = StickyFollowGui
ScreenGui.ResetOnSpawn = false 
ScreenGui.Parent = game.Players.LocalPlayerWaitForChild(PlayerGui)

local Frame = Instance.new(Frame)
Frame.Size = UDim2.new(0, 260, 0, 500) -- Frameのサイズをボタンとスライダーに合わせて調整
Frame.Position = UDim2.new(0.5, -130, 0.5, -250)
Frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
Frame.BackgroundTransparency = 0.2
Frame.Active = true
Frame.Draggable = true
Frame.Parent = ScreenGui

local StatusLabel = Instance.new(TextLabel, Frame)
StatusLabel.Size = UDim2.new(1, -40, 0, 20)
StatusLabel.Position = UDim2.new(0, 5, 0, 0)
StatusLabel.Text = 張り付き OFF
StatusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
StatusLabel.BackgroundTransparency = 1
StatusLabel.TextXAlignment = Enum.TextXAlignment.Left

-- 最小化ボタン
local MinimizeButton = Instance.new(TextButton, Frame)
MinimizeButton.Size = UDim2.new(0, 30, 0, 20)
MinimizeButton.Position = UDim2.new(1, -35, 0, 0)
MinimizeButton.Text = -
MinimizeButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
MinimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)

-- 最小化機能
MinimizeButton.MouseButton1ClickConnect(function()
    minimized = not minimized
    if minimized then
        Frame.Size = UDim2.new(0, 260, 0, 30)
        for _, child in ipairs(FrameGetChildren()) do
            if child ~= MinimizeButton and child ~= StatusLabel then
                child.Visible = false
            end
        end
    else
        Frame.Size = UDim2.new(0, 260, 0, 500)
        for _, child in ipairs(FrameGetChildren()) do
            child.Visible = true
        end
        -- 最小化解除時にボタンとスライダーを再表示 (念のため)
        ToggleButton.Visible = true
    end
end)

-- プレイヤーリスト用スクロールフレーム
local ScrollFrame = Instance.new(ScrollingFrame, Frame)
ScrollFrame.Size = UDim2.new(1, -10, 0.35, -35) -- サイズを少し小さく調整
ScrollFrame.Position = UDim2.new(0, 5, 0, 25)
ScrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
ScrollFrame.ScrollBarThickness = 8
ScrollFrame.BackgroundTransparency = 1
ScrollFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y

local ListLayout = Instance.new(UIListLayout, ScrollFrame)
ListLayout.Padding = UDim.new(0, 5)
ListLayout.SortOrder = Enum.SortOrder.LayoutOrder

-- プレイヤーリスト生成 (関数は変更なし)
local function refreshPlayerList()
    for _, v in ScrollFrameGetChildren() do
        if vIsA(TextButton) then
            vDestroy()
        end
    end

    for _, player in ipairs(PlayersGetPlayers()) do
        if player ~= LocalPlayer then
            local btn = Instance.new(TextButton, ScrollFrame)
            btn.Size = UDim2.new(1, 0, 0, 30)
            btn.Text = player.DisplayName ..  [@ .. player.Name .. ]
            btn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
            btn.TextColor3 = Color3.fromRGB(255, 255, 255)
            btn.TextScaled = true
            btn.MouseButton1ClickConnect(function()
                targetPlayer = player
                StatusLabel.Text = ターゲット  .. player.Name
                print(ターゲット選択  .. player.Name)
            end)
        end
    end
end

-- プレイヤー追加削除時のリスト更新 (関数は変更なし)
Players.PlayerAddedConnect(refreshPlayerList)
Players.PlayerRemovingConnect(function()
    if targetPlayer and not PlayersFindFirstChild(targetPlayer.Name) then
        targetPlayer = nil
        StatusLabel.Text = ターゲット なし
    end
    refreshPlayerList()
end)

refreshPlayerList()

-- 粘着ONOFF切り替えボタン (追加部分)
local ToggleButton = Instance.new(TextButton, Frame)
ToggleButton.Size = UDim2.new(1, -10, 0, 40)
ToggleButton.Position = UDim2.new(0, 5, 0, 190) -- スクロールフレームの下に配置
ToggleButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0) -- 初期値は緑 (OFF)
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.Text = 張り付き ONOFF (Nキー)
ToggleButton.TextSize = 18

-- ボタンクリック機能
ToggleButton.MouseButton1ClickConnect(function()
    following = not following
    StatusLabel.Text = 張り付き  .. (following and ON or OFF)
    
    -- ボタンの色を更新
    if following then
        ToggleButton.BackgroundColor3 = Color3.fromRGB(150, 0, 0) -- ON時は赤
    else
        ToggleButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0) -- OFF時は緑
    end
end)

-- 距離調整用のスライダーを作成する関数 (変更なし)
local function createDistanceControls(axis, positionY, defaultValue)
    local sliderLabel = Instance.new(TextLabel, Frame)
    sliderLabel.Size = UDim2.new(0.4, -10, 0, 25)
    sliderLabel.Position = UDim2.new(0, 5, 0, positionY)
    sliderLabel.Text = axis ..   .. tostring(defaultValue)
    sliderLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    sliderLabel.BackgroundTransparency = 1
    sliderLabel.TextSize = 16
    sliderLabel.TextXAlignment = Enum.TextXAlignment.Left

    local slider = Instance.new(TextButton, Frame)
    slider.Size = UDim2.new(1, -10, 0, 20)
    slider.Position = UDim2.new(0, 5, 0, positionY + 30)
    slider.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    slider.Text = 

    local knob = Instance.new(Frame, slider)
    knob.Size = UDim2.new(0, 10, 1, 0)
    knob.Position = UDim2.new((defaultValue - minDistance)  (maxDistance - minDistance), 0, 0, 0)
    knob.BackgroundColor3 = Color3.fromRGB(255, 255, 255)

    local dragging = false
    slider.InputBeganConnect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = true end
    end)
    UserInputService.InputEndedConnect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
    end)
    UserInputService.InputChangedConnect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local relX = math.clamp((input.Position.X - slider.AbsolutePosition.X)  slider.AbsoluteSize.X, 0, 1)
            local value = math.floor(minDistance + relX  (maxDistance - minDistance) + 0.5)
            knob.Position = UDim2.new((value - minDistance)  (maxDistance - minDistance), 0, 0, 0)
            sliderLabel.Text = axis ..   .. tostring(value)
            if axis == X then
                followDistanceX = value
            elseif axis == Y then
                followDistanceY = value
            elseif axis == Z then
                followDistanceZ = value
            end
        end
    end)
end

-- 距離調整用スライダー生成 (座標を修正)
createDistanceControls(X, 240, followDistanceX)
createDistanceControls(Y, 300, followDistanceY)
createDistanceControls(Z, 360, followDistanceZ)

-- 粘着ONOFFキー (ボタンの機能と合わせるため、ボタンの状態も更新)
UserInputService.InputBeganConnect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.N then
        following = not following
        StatusLabel.Text = 張り付き  .. (following and ON or OFF)
        
        -- ボタンの色を更新
        if following then
            ToggleButton.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
        else
            ToggleButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
        end
    end
end)

-- 粘着処理 (変更なし)
RunService.RenderSteppedConnect(function()
    if following and targetPlayer and targetPlayer.Character and targetPlayer.CharacterFindFirstChild(HumanoidRootPart) then
        Character = LocalPlayer.Character or LocalPlayer.CharacterAddedWait()
        HRP = CharacterFindFirstChild(HumanoidRootPart)
        if HRP then
            local targetHRP = targetPlayer.Character.HumanoidRootPart
            HRP.CFrame = targetHRP.CFrame  CFrame.new(followDistanceX, followDistanceY, followDistanceZ)
        end
    end
end)

